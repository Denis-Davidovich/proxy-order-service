# Анализ и улучшение схемы БД (таблица `orders`)

## Проблемы текущей схемы

### 1. **Избыточность полей идентификации**
```sql
hash    varchar(32)  -- md5 hash
token   varchar(64)  -- unique user hash
number  varchar(10)  -- order number
```
**Проблема**: Три разных идентификатора для одного заказа. `hash` (MD5) и `token` выполняют одинаковую функцию.
**Решение**: Оставить один `token` (более безопасный), убрать `hash`. Для номера заказа использовать автоинкремент + префикс.

### 2. **Отсутствие нормализации (слишком широкая таблица)**
**Проблема**: 77 колонок в одной таблице - нарушение 3NF:
- Адресные поля (delivery_*) - отдельная таблица `order_addresses`
- Данные менеджера (manager_*) - связь с таблицей `managers`
- Данные перевозчика (carrier_*) - связь с таблицей `carriers`
- Банковские реквизиты - отдельная таблица `payment_details`

**Решение**: Разбить на 5 таблиц: `orders`, `order_addresses`, `order_delivery`, `order_payments`, `order_tracking`

### 3. **Отсутствие связи с товарами/ценами**
**Проблема**:
- Для эндпоинта №1 (получение цены плитки) нет поля `price`
- Нет связи заказа с товарами (factory, collection, article из ТЗ)
- Таблица `orders_article` есть в дампе (строка 96), но связь не используется

**Решение**: Использовать связь `orders` ↔ `orders_article` (Many-to-Many через pivot)

### 4. **Слабая типизация**
```sql
status     int     -- без ENUM или CHECK constraint
vat_type   int     -- без ограничений
pay_type   smallint -- без ограничений
```
**Проблема**: Магические числа без валидации на уровне БД.
**Решение**:
```sql
status ENUM('new', 'processing', 'paid', 'shipped', 'delivered', 'cancelled')
vat_type ENUM('individual', 'company')
pay_type ENUM('card', 'bank_transfer', 'cash')
```

### 5. **Неоптимальные индексы**
**Текущие индексы**:
```sql
IDX_1 (delivery_country)       -- используется?
IDX_2 (user_id)                -- OK
IDX_3 (create_date)            -- OK (для статистики)
IDX_4 (create_date, status)    -- избыточен с IDX_3
IDX_5 (hash)                   -- hash нужно удалить
```

**Проблема**:
- Нет индекса на `email` (для поиска заказов клиента)
- Нет индекса на `token` (используется для доступа к заказу)
- Нет индекса на `status` (для фильтрации заказов)
- `IDX_4` избыточен, т.к. покрывается `IDX_3`

**Решение**:
```sql
CREATE INDEX idx_orders_token ON orders(token);
CREATE INDEX idx_orders_email ON orders(email);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_user_status ON orders(user_id, status); -- композитный
DROP INDEX IDX_4; -- избыточен
```

### 6. **Отсутствие constraints**
**Проблема**:
- Нет `FOREIGN KEY` для `user_id`, `delivery_country`
- Нет `CHECK` constraints для числовых полей (discount 0-100, status > 0)
- Нет `UNIQUE` constraint на `token`

**Решение**:
```sql
CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
CONSTRAINT uq_orders_token UNIQUE (token)
CONSTRAINT chk_discount CHECK (discount BETWEEN 0 AND 100)
CONSTRAINT chk_status CHECK (status > 0)
```

### 7. **Избыточные nullable поля**
**Проблема**: Почти все поля `NULL` - усложняет работу с данными.
**Решение**: Определить обязательные поля:
```sql
name VARCHAR(200) NOT NULL
status INT NOT NULL DEFAULT 1
locale VARCHAR(5) NOT NULL
pay_type SMALLINT NOT NULL
create_date DATETIME NOT NULL
```

---

## Улучшенная схема

### Основная таблица `orders` (минимальная)
```sql
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,

    -- Идентификация
    token VARCHAR(64) NOT NULL UNIQUE COMMENT 'Secure access token (SHA256)',
    order_number VARCHAR(20) NULL COMMENT 'Human-readable order number',

    -- Связи
    user_id INT NULL,

    -- Основная информация
    name VARCHAR(255) NOT NULL COMMENT 'Order name',
    status ENUM('new', 'pending', 'processing', 'paid', 'shipped', 'delivered', 'cancelled') NOT NULL DEFAULT 'new',
    email VARCHAR(100) NULL,

    -- Финансы
    pay_type ENUM('card', 'bank_transfer', 'invoice', 'cash') NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'EUR',
    discount SMALLINT NULL CHECK (discount BETWEEN 0 AND 100),
    total_amount DECIMAL(10,2) NULL COMMENT 'Total order amount in currency',

    -- Метаданные
    locale VARCHAR(5) NOT NULL DEFAULT 'en',
    description TEXT NULL,
    search_text TEXT NULL COMMENT 'Denormalized data for Manticore search',

    -- Даты
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_date DATETIME NULL ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME NULL COMMENT 'Soft delete timestamp',

    -- Индексы
    INDEX idx_token (token),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_create_date (create_date),
    INDEX idx_user_status (user_id, status),
    FULLTEXT INDEX ft_search (search_text),

    -- Foreign keys
    CONSTRAINT fk_orders_user FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE SET NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Orders main table';
```

### Новая таблица `order_items` (товары в заказе)
```sql
CREATE TABLE order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,

    -- Данные плитки из эндпоинта №1
    factory VARCHAR(100) NOT NULL COMMENT 'Tile factory name',
    collection VARCHAR(100) NOT NULL COMMENT 'Tile collection name',
    article VARCHAR(255) NOT NULL COMMENT 'Tile article code',

    -- Цена и количество
    price DECIMAL(10,2) NOT NULL COMMENT 'Price per item in EUR',
    quantity DECIMAL(10,2) NOT NULL DEFAULT 1,
    total DECIMAL(10,2) NOT NULL COMMENT 'price * quantity',

    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order (order_id),
    INDEX idx_article (factory, collection, article),

    CONSTRAINT fk_items_order FOREIGN KEY (order_id)
        REFERENCES orders(id) ON DELETE CASCADE

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
COMMENT='Order line items with tile data';
```

### Новая таблица `order_delivery` (доставка)
```sql
CREATE TABLE order_delivery (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL UNIQUE,

    -- Адрес
    country_id INT NULL,
    city VARCHAR(200) NULL,
    address VARCHAR(300) NULL,
    postal_code VARCHAR(20) NULL,
    phone VARCHAR(30) NULL,

    -- Сроки
    delivery_date_min DATE NULL,
    delivery_date_max DATE NULL,

    -- Стоимость
    delivery_cost DECIMAL(10,2) NULL,
    delivery_type ENUM('address', 'pickup') NOT NULL DEFAULT 'address',

    -- Трекинг
    tracking_number VARCHAR(100) NULL,
    carrier_name VARCHAR(100) NULL,
    shipped_at DATETIME NULL,
    delivered_at DATETIME NULL,

    CONSTRAINT fk_delivery_order FOREIGN KEY (order_id)
        REFERENCES orders(id) ON DELETE CASCADE

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## Миграция данных

```sql
-- 1. Создать улучшенные таблицы
CREATE TABLE orders_new (...);
CREATE TABLE order_items (...);
CREATE TABLE order_delivery (...);

-- 2. Мигрировать данные
INSERT INTO orders_new (id, token, name, status, email, ...)
SELECT id, token, name, status, email, ...
FROM orders;

-- 3. Переименовать таблицы
RENAME TABLE orders TO orders_old, orders_new TO orders;

```

---

## Преимущества новой схемы

✅ **Производительность**:
- Индекс на `create_date` для эндпоинта №2
- Композитные индексы для частых запросов
- Нормализация уменьшает размер таблицы

✅ **Масштабируемость**:
- Разделение на таблицы позволяет шардинг

✅ **Безопасность**:
- Foreign keys защищают целостность
- UNIQUE constraint на token
- CHECK constraints валидируют данные

✅ **Соответствие ТЗ**:
- Поле `price` для эндпоинта №1
- Связь с товарами (factory, collection, article)
- Поле `search_text` для Manticore (эндпоинт №4)
- Индекс на `create_date` для эндпоинта №2

✅ **Symfony Best Practices**:
- Меньше полей в Entity = проще работать с ORM
- Foreign keys = автоматический каскад
- Нормализация = использование Relations (OneToMany, ManyToOne)